<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Distributed FFT plans · PencilFFTs.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://jipolanco.github.io/PencilFFTs.jl/PencilFFTs/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/custom.css" rel="stylesheet" type="text/css"/><script src="../assets/tomate.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="PencilFFTs.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">PencilFFTs.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../generated/gradient/">Gradient of a scalar field</a></li><li><a class="tocitem" href="../generated/navier_stokes/">Navier–Stokes equations</a></li><li><a class="tocitem" href="../generated/in-place/">In-place transforms</a></li></ul></li><li><span class="tocitem">Library</span><ul><li class="is-active"><a class="tocitem" href>Distributed FFT plans</a><ul class="internal"><li><a class="tocitem" href="#Creating-plans"><span>Creating plans</span></a></li><li><a class="tocitem" href="#Allocating-data"><span>Allocating data</span></a></li><li><a class="tocitem" href="#Methods"><span>Methods</span></a></li></ul></li><li><a class="tocitem" href="../Transforms/">Available transforms</a></li><li><a class="tocitem" href="../PencilFFTs_timers/">Measuring performance</a></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../GlobalFFTParams/">Global FFT parameters</a></li></ul></li></ul></li><li><a class="tocitem" href="../benchmarks/">Benchmarks</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Library</a></li><li class="is-active"><a href>Distributed FFT plans</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Distributed FFT plans</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/jipolanco/PencilFFTs.jl/blob/master/docs/src/PencilFFTs.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Distributed-FFT-plans"><a class="docs-heading-anchor" href="#Distributed-FFT-plans">Distributed FFT plans</a><a id="Distributed-FFT-plans-1"></a><a class="docs-heading-anchor-permalink" href="#Distributed-FFT-plans" title="Permalink"></a></h1><p>Distributed FFTs are implemented in the <code>PencilFFTs</code> module, and are built on top of the <a href="https://github.com/jipolanco/PencilArrays.jl">PencilArrays</a> package.</p><h2 id="Creating-plans"><a class="docs-heading-anchor" href="#Creating-plans">Creating plans</a><a id="Creating-plans-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-plans" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PencilFFTs.PencilFFTPlan" href="#PencilFFTs.PencilFFTPlan"><code>PencilFFTs.PencilFFTPlan</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">PencilFFTPlan{T,N} &lt;: AbstractFFTs.Plan{T}</code></pre><p>Plan for N-dimensional FFT-based transform on MPI-distributed data, where input data has type <code>T</code>.</p><hr/><pre><code class="nohighlight hljs">PencilFFTPlan(p::Pencil, transforms; kwargs...)</code></pre><p>Create a <code>PencilFFTPlan</code> for distributed arrays following a given <a href="https://jipolanco.github.io/PencilArrays.jl/dev/Pencils/#PencilArrays.Pencils.Pencil"><code>Pencil</code></a> configuration. See variant below for details on the specification of <code>transforms</code> and on possible keyword arguments.</p><hr/><pre><code class="nohighlight hljs">PencilFFTPlan(
    A::PencilArray, transforms;
    fftw_flags = FFTW.ESTIMATE,
    fftw_timelimit = FFTW.NO_TIMELIMIT,
    permute_dims = Val(true),
    transpose_method = Transpositions.PointToPoint(),
    timer = timer(pencil(A)),
)</code></pre><p>Create plan for <code>N</code>-dimensional transform on MPI-distributed <code>PencilArray</code>s.</p><p><strong>Extended help</strong></p><p>This creates a <code>PencilFFTPlan</code> for arrays sharing the same properties as <code>A</code> (dimensions, MPI decomposition, memory layout, ...), which describe data on an <code>N</code>-dimensional domain.</p><p><strong>Transforms</strong></p><p>The transforms to be applied along each dimension are specified by the <code>transforms</code> argument. Possible transforms are defined as subtypes of <a href="../Transforms/#PencilFFTs.Transforms.AbstractTransform"><code>Transforms.AbstractTransform</code></a>, and are listed in <a href="../Transforms/#Transform-types">Transform types</a>. This argument may be either:</p><ul><li><p>a tuple of <code>N</code> transforms to be applied along each dimension. For instance, <code>transforms = (Transforms.R2R(FFTW.REDFT01), Transforms.RFFT(), Transforms.FFT())</code>;</p></li><li><p>a single transform to be applied along all dimensions. The input is automatically expanded into <code>N</code> equivalent transforms. For instance, for a three-dimensional array, <code>transforms = Transforms.RFFT()</code> specifies a 3D real-to-complex transform, and is equivalent to passing <code>(Transforms.RFFT(), Transforms.FFT(), Transforms.FFT())</code>.</p></li></ul><p>Note that forward transforms are applied from left to right. In the last example, this means that a real-to-complex transform (<code>RFFT</code>) is first performed along the first dimension. This is followed by complex-to-complex transforms (<code>FFT</code>) along the second and third dimensions.</p><p><strong>Input data layout</strong></p><p>The input <code>PencilArray</code> must satisfy the following constraints:</p><ul><li><p>array dimensions must <em>not</em> be permuted. This is the default when constructing <code>PencilArray</code>s.</p></li><li><p>for an <code>M</code>-dimensional domain decomposition (with <code>M &lt; N</code>), the input array must be decomposed along the <em>last <code>M</code> dimensions</em>. For example, for a 2D decomposition of 3D data, the decomposed dimensions must be <code>(2, 3)</code>. In particular, the first array dimension must <em>not</em> be distributed among different MPI processes.</p><p>In the PencilArrays package, the decomposed dimensions are specified at the moment of constructing a <a href="https://jipolanco.github.io/PencilArrays.jl/dev/Pencils/#PencilArrays.Pencils.Pencil"><code>Pencil</code></a>.</p></li><li><p>the element type must be compatible with the specified transform. For instance, real-to-complex transforms (<code>Transforms.RFFT</code>) require the input to be real floating point values. Other transforms, such as <code>Transforms.R2R</code>, accept both real and complex data.</p></li></ul><p><strong>Keyword arguments</strong></p><ul><li><p>The keyword arguments <code>fftw_flags</code> and <code>fftw_timelimit</code> are passed to the <code>FFTW</code> plan creation functions (see <a href="https://juliamath.github.io/AbstractFFTs.jl/stable/api/#AbstractFFTs.plan_fft"><code>AbstractFFTs</code> docs</a>).</p></li><li><p><code>permute_dims</code> determines whether the indices of the output data should be reversed. For instance, if the input data has global dimensions <code>(Nx, Ny, Nz)</code>, then the output of a complex-to-complex FFT would have dimensions <code>(Nz, Ny, Nx)</code>. This enables FFTs to always be performed along the first (i.e. fastest) array dimension, which could lead to performance gains. This option is enabled by default. For type inference reasons, it must be a value type (<code>Val(true)</code> or <code>Val(false)</code>).</p></li><li><p><code>transpose_method</code> allows to select between implementations of the global data transpositions. See <a href="https://jipolanco.github.io/PencilArrays.jl/dev/Transpositions/#PencilArrays.Transpositions.Transposition">PencilArrays docs</a> docs for details.</p></li><li><p><code>timer</code> should be a <code>TimerOutput</code> object. See <a href="../PencilFFTs_timers/#PencilFFTs.measuring_performance">Measuring performance</a> for details.</p></li></ul><hr/><pre><code class="nohighlight hljs">PencilFFTPlan(
    dims_global::Dims{N}, transforms, proc_dims::Dims{M}, comm::MPI.Comm,
    [real_type = Float64]; extra_dims = (), kws...
)</code></pre><p>Create plan for N-dimensional transform.</p><p><strong>Extended help</strong></p><p>Instead of taking a <code>PencilArray</code> or a <code>Pencil</code>, this constructor requires the global dimensions of the input data, passed via the <code>size_global</code> argument.</p><p>The data is distributed over the MPI processes in the <code>comm</code> communicator. The distribution is performed over <code>M</code> dimensions (with <code>M &lt; N</code>) according to the values in <code>proc_dims</code>, which specifies the number of MPI processes to put along each dimension.</p><p><code>PencilArray</code>s that may be transformed with the returned plan can be created using <a href="#PencilFFTs.allocate_input"><code>allocate_input</code></a>.</p><p><strong>Optional arguments</strong></p><ul><li><p>The floating point precision can be selected by setting <code>real_type</code> parameter, which is <code>Float64</code> by default.</p></li><li><p><code>extra_dims</code> may be used to specify the sizes of one or more extra dimensions that should not be transformed. These dimensions will be added to the rightmost (i.e. slowest) indices of the arrays. See <strong>Extra dimensions</strong> below for usage hints.</p></li><li><p>see the other constructor for more keyword arguments.</p></li></ul><p><strong>Extra dimensions</strong></p><p>One possible application of <code>extra_dims</code> is for describing the components of a vector or tensor field. However, this means that different <code>PencilFFTPlan</code>s would need to be created for each kind of field (scalar, vector, ...). To avoid the creation of multiple plans, a possibly better alternative is to create tuples (or arrays) of <code>PencilArray</code>s using <a href="#PencilFFTs.allocate_input"><code>allocate_input</code></a> and <a href="#PencilFFTs.allocate_output"><code>allocate_output</code></a>.</p><p>Another more legitimate usage of <code>extra_dims</code> is to specify one or more Cartesian dimensions that should not be transformed nor split among MPI processes.</p><p><strong>Example</strong></p><p>Suppose we want to perform a 3D FFT of real data. The data is to be decomposed along two dimensions, over 8 MPI processes:</p><pre><code class="language-julia hljs">size_global = (64, 32, 128)  # size of real input data

# Perform real-to-complex transform along the first dimension, then
# complex-to-complex transforms along the other dimensions.
transforms = (Transforms.RFFT(), Transforms.FFT(), Transforms.FFT())
# transforms = Transforms.RFFT()  # this is equivalent to the above line

proc_dims = (4, 2)  # 2D decomposition
comm = MPI.COMM_WORLD

plan = PencilFFTPlan(size_global, transforms, proc_dims, comm)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/plans.jl#LL38-L203">source</a></section></article><h2 id="Allocating-data"><a class="docs-heading-anchor" href="#Allocating-data">Allocating data</a><a id="Allocating-data-1"></a><a class="docs-heading-anchor-permalink" href="#Allocating-data" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PencilFFTs.allocate_input" href="#PencilFFTs.allocate_input"><code>PencilFFTs.allocate_input</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">allocate_input(p::PencilFFTPlan)          -&gt; PencilArray
allocate_input(p::PencilFFTPlan, dims...) -&gt; Array{PencilArray}
allocate_input(p::PencilFFTPlan, Val(N))  -&gt; NTuple{N, PencilArray}</code></pre><p>Allocate uninitialised <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#PencilArrays.PencilArray"><code>PencilArray</code></a> that can hold input data for the given plan.</p><p>The second and third forms respectively allocate an array of <code>PencilArray</code>s of size <code>dims</code>, and a tuple of <code>N</code> <code>PencilArray</code>s.</p><div class="admonition is-info"><header class="admonition-header">In-place plans</header><div class="admonition-body"><p>If <code>p</code> is an in-place plan, a <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#PencilArrays.ManyPencilArray"><code>ManyPencilArray</code></a> is allocated. This type holds <code>PencilArray</code> wrappers for the input and output transforms (as well as for intermediate transforms) which share the same space in memory. The input and output <code>PencilArray</code>s should be respectively accessed by calling <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#Base.first-Tuple{ManyPencilArray}"><code>first(::ManyPencilArray)</code></a> and <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#Base.last-Tuple{ManyPencilArray}"><code>last(::ManyPencilArray)</code></a>.</p><h4>Example</h4><p>Suppose <code>p</code> is an in-place <code>PencilFFTPlan</code>. Then,</p><pre><code class="language-julia hljs">@assert is_inplace(p)
A = allocate_input(p) :: ManyPencilArray
v_in = first(A)       :: PencilArray  # input data view
v_out = last(A)       :: PencilArray  # output data view</code></pre><p>Also note that in-place plans must be performed directly on the returned <code>ManyPencilArray</code>, and not on the contained <code>PencilArray</code> views:</p><pre><code class="language-julia hljs">p * A       # perform forward transform in-place
p \ A       # perform backward transform in-place
# p * v_in  # not allowed!!</code></pre></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/allocate.jl#LL1-L41">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PencilFFTs.allocate_output" href="#PencilFFTs.allocate_output"><code>PencilFFTs.allocate_output</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">allocate_output(p::PencilFFTPlan)          -&gt; PencilArray
allocate_output(p::PencilFFTPlan, dims...) -&gt; Array{PencilArray}
allocate_output(p::PencilFFTPlan, Val(N))  -&gt; NTuple{N, PencilArray}</code></pre><p>Allocate uninitialised <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#PencilArrays.PencilArray"><code>PencilArray</code></a> that can hold output data for the given plan.</p><p>If <code>p</code> is an in-place plan, a <a href="https://jipolanco.github.io/PencilArrays.jl/dev/PencilArrays/#PencilArrays.ManyPencilArray"><code>ManyPencilArray</code></a> is allocated.</p><p>See <a href="#PencilFFTs.allocate_input"><code>allocate_input</code></a> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/allocate.jl#LL67-L78">source</a></section></article><h2 id="Methods"><a class="docs-heading-anchor" href="#Methods">Methods</a><a id="Methods-1"></a><a class="docs-heading-anchor-permalink" href="#Methods" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PencilArrays.Pencils.MPITopologies.get_comm-Tuple{PencilFFTPlan}" href="#PencilArrays.Pencils.MPITopologies.get_comm-Tuple{PencilFFTPlan}"><code>PencilArrays.Pencils.MPITopologies.get_comm</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">get_comm(p::PencilFFTPlan)</code></pre><p>Get MPI communicator associated to a <code>PencilFFTPlan</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/plans.jl#LL564-L568">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PencilFFTs.Transforms.scale_factor-Tuple{PencilFFTPlan}" href="#PencilFFTs.Transforms.scale_factor-Tuple{PencilFFTPlan}"><code>PencilFFTs.Transforms.scale_factor</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">scale_factor(p::PencilFFTPlan)</code></pre><p>Get scale factor associated to a <code>PencilFFTPlan</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/plans.jl#LL571-L575">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PencilArrays.Pencils.timer-Tuple{PencilFFTPlan}" href="#PencilArrays.Pencils.timer-Tuple{PencilFFTPlan}"><code>PencilArrays.Pencils.timer</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">timer(p::PencilFFTPlan)</code></pre><p>Get <code>TimerOutput</code> attached to a <code>PencilFFTPlan</code>.</p><p>See <a href="../PencilFFTs_timers/#PencilFFTs.measuring_performance">Measuring performance</a> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/plans.jl#LL578-L584">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PencilFFTs.Transforms.is_inplace-Tuple{PencilFFTPlan}" href="#PencilFFTs.Transforms.is_inplace-Tuple{PencilFFTPlan}"><code>PencilFFTs.Transforms.is_inplace</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">Transforms.is_inplace(p::PencilFFTPlan)</code></pre><p>Returns <code>true</code> if the given plan operates in-place on the input data, <code>false</code> otherwise.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/jipolanco/PencilFFTs.jl/blob/964c0a36c046b83119fa36ed5520bf4db8bd16e8/src/plans.jl#LL338-L343">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../generated/in-place/">« In-place transforms</a><a class="docs-footer-nextpage" href="../Transforms/">Available transforms »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 15 March 2023 15:52">Wednesday 15 March 2023</span>. Using Julia version 1.9.0-rc1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
